pipeline { 
  
   agent any
   
   
  environment {
            AWS_ACCOUNT_ID="517446614341"
            IAM_ROLE="adminRole"
   }

   stages {
   
     stage('Test aws cli') { 
        steps {
           withAWS(roleAccount: "${AWS_ACCOUNT_ID}" , role: "${IAM_ROLE}") {
           sh '''
                aws s3 ls
           '''    
        }
      }
     }   
   
     stage('Terraform Init-Validate-Plan') { 
        steps { 
        
           withAWS(roleAccount:"123", role:"role") {
           sh '''
                cd terraform/env/${GIT_BRANCH}
                terraform init -backend-config="key=terraform-tfstate/env/${GIT_BRANCH}/terraform.tfstate" -no-color
                terraform validate -no-color
                terraform plan -no-color
           '''    
        }
     }
    }
     
     
stage('Waiting for Approvals') {
            
      steps{
          input('Plan Validated? Please approve to create resources in AWS?')
			  }
      }    
     
     
     stage('Terraform Apply') { 
        steps { 
           withAWS(roleAccount:'517446614341', role:'adminRole') {
           sh 'cd terraform/env/${GIT_BRANCH} && terraform apply -auto-approve -no-color'
        }
      }
     }

     stage('Run Glue Workflow Pipeline') { 
        steps { 
           withAWS(roleAccount:'517446614341', role:'adminRole') {
           sh 'aws glue start-workflow-run --name cfm-etl-workflow_${params.environment} --region us-east-2'
        }
      }
     }

   	}
parameters {
    choice(choices: ['dev', 'prod'], description: 'What environment?', name: 'environment')
  }    

   }
